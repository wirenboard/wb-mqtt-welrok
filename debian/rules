#!/usr/bin/make -f
#
# Build Debian package using https://github.com/spotify/dh-virtualenv
#
# The below targets create a clean copy of the workdir via
# using "sdist", else "pip" goes haywire when installing from
# sourcedir ".", because that includes the debian build stage,
# and a recursive explosion ensues when symlinks are followed.
#
# It also ensures your MANIFEST is complete and at least covers
# all files needed for a release build.

# Increase trace logging, see debhelper(7) (uncomment to enable)
#DH_VERBOSE=1

export DH_VIRTUALENV_INSTALL_ROOT=/opt/venvs
SNAKE=/usr/bin/python3
EXTRA_REQUIREMENTS=--upgrade-pip --preinstall "setuptools>=38" --preinstall "wheel"
DH_VENV_ARGS=--builtin-venv --python=$(SNAKE) $(EXTRA_REQUIREMENTS)
PACKAGE=$(shell dh_listpackages)
VERSION=$(shell $(SNAKE) setup.py --version)
SDIST_DIR=debian/$(PACKAGE)-$(VERSION)


.PHONY: clean build-arch override_dh_virtualenv override_dh_strip
	# override_dh_shlibdeps

clean:
	test ! -d dist || rm -rf dist
	test ! -d $(SDIST_DIR) || rm -rf $(SDIST_DIR)/*
	dh $@ $(DH_VENV_ARGS)

build-arch:
	$(SNAKE) setup.py sdist --formats tar
	mkdir -p $(SDIST_DIR)
	tar -x -C $(SDIST_DIR) --strip-components=1 --exclude '*.egg-info' -f dist/*.tar
	# Use the extracted sdist as the source directory to avoid running
	# python-distutils handlers against the debian/ tree in the repo root.
	dh $@ $(DH_VENV_ARGS) --sourcedir $(SDIST_DIR)

%:
	dh $@ --with python-virtualenv --with systemd

override_dh_virtualenv:
	dh_virtualenv $(DH_VENV_ARGS)

	# Clean up artifacts that are noisy for lintian and unnecessary in the
	# packed venv (wheel caches, __pycache__ directories, Windows executables,
	# redundant easy_install wrappers, compiled python cache files).
	VENV=debian/$(PACKAGE)/opt/venvs/$(PACKAGE)
	# remove wheel caches created by pip
	rm -rf $(VENV)/share/python-wheels || true
	# remove compiled python caches
	find $(VENV) -type d -name '__pycache__' -exec rm -rf {} + || true
	find $(VENV) -type f -name '*.pyc' -exec rm -f {} + || true
	# remove leftover wheel and pip binaries/metadata we don't want packaged
	find $(VENV) -type f -iname '*.exe' -exec rm -f {} + || true
	rm -f $(VENV)/bin/easy_install* || true


override_dh_auto_clean:
	# Prevent dh_auto_clean from invoking python-distutils/pyversions which
	# isn't available in some build environments; make this step a no-op.
	true

override_dh_auto_configure:
	# don't run python-distutils based configure; dh_virtualenv will handle
	# package installation inside the venv
	true

override_dh_auto_build:
	# Avoid calling pyversions via dh_auto_build (pyversions may be missing
	# in minimal build environments). dh_virtualenv will build the venv.
	true

override_dh_strip:
	dh_strip --exclude=cffi --exclude=_imaging

override_dh_auto_install:
	# Install files then remove any python __pycache__ directories from the
	# binary package area to avoid lintian's package-installs-python-pycache-dir
	dh_auto_install
	find debian/$(shell dh_listpackages) -type d -name '__pycache__' -exec rm -rf {} + || true
	dh_systemd_enable || true
	dh_systemd_start || true
#override_dh_shlibdeps:
#	dh_shlibdeps -X/x86/ -X/Cython/ -X/PIL/ -X/psycopg2/ -X/_yaml

override_dh_genchanges:
	# Ensure generated .changes use a valid Changed-By value in CI builds
	# where the builder identity might be anonymized. Prefer setting the
	# DEBFULLNAME/DEBEMAIL environment a) to make dpkg-genchanges write a
	# correct Changed-By and b) to avoid fragile post-processing.
	# Extract Maintainer from debian/control and export DEB env vars.
	MAINT_LINE="$$(awk -F': ' '/^Maintainer:/ {print $$2; exit}' debian/control || true)"
	if [ -n "$$MAINT_LINE" ]; then
		# Parse 'Name <email>' gracefully: capture email if present
		MAINT_EMAIL="$$(echo "$$MAINT_LINE" | sed -n 's/.*<\([^>]*\)>.*/\1/p' || true)"
		MAINT_NAME="$$(echo "$$MAINT_LINE" | sed -n 's/\(.*\) <.*>/\1/p' || true)"
		if [ -z "$$MAINT_NAME" ]; then
			# if no angle brackets found, use the whole line as name
			MAINT_NAME="$$MAINT_LINE"
		fi
		if [ -n "$$MAINT_EMAIL" ]; then
			export DEBEMAIL="$$MAINT_EMAIL"
		fi
		export DEBFULLNAME="$$MAINT_NAME"
	fi

	# Generate changes using the DEB env vars (if set)
	dh_genchanges
	# Resolve a sensible replacement value: prefer the debian/control Maintainer
	# line; fall back to a clear CI marker if not found.
	MAINT="$$(awk -F': ' '/^Maintainer:/ {print $$2; exit}' debian/control || true)"
	if [ -z "$$MAINT" ]; then
		MAINT="CI Builder <ci-builder@wirenboard.com>"
	fi
	# Look for .changes files in a few likely places and normalize Changed-By
	for f in ../*.changes ../../*.changes *.changes; do \
		[ -f "$$f" ] || continue; \
		# Replace various possible anonymized forms (with or without angle brackets)
		# Detect broader range of anonymized placeholders (case-insensitive)
		if grep -Eiq "(nobody|nowhere|no-?reply)" "$$f"; then \
			echo "fixing Changed-By in $$f"; \
			# Use an extended case-insensitive regex to replace the whole Changed-By: line
			sed -E -i "s|^Changed-By:[[:space:]]*.*(nobody|nowhere|no-?reply).*$$|Changed-By: $$MAINT|Ig" "$$f" || true; \
		fi; \
	done || true
